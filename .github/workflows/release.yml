name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build extension
        run: pnpm build

      - name: Create ZIP package
        run: pnpm zip

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # å¦‚æžœæ²¡æœ‰ä¸Šä¸€ä¸ª tagï¼ŒèŽ·å–æ‰€æœ‰æäº¤
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # èŽ·å–ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # åˆ†ç±»æäº¤ä¿¡æ¯
          FEATURES=$(echo "$COMMITS" | grep -E "^- (feat|feature)" || true)
          FIXES=$(echo "$COMMITS" | grep -E "^- (fix|bugfix)" || true)
          OTHERS=$(echo "$COMMITS" | grep -vE "^- (feat|feature|fix|bugfix)" || true)

          # æž„å»º release notes
          NOTES="## ðŸŽ‰ Bç«™æ”¶è—å¤¹æ•´ç†å·¥å…· v${{ steps.get_version.outputs.VERSION }}"
          NOTES+="\n\n"

          if [ -n "$FEATURES" ]; then
            NOTES+="### âœ¨ æ–°åŠŸèƒ½\n$FEATURES\n\n"
          fi

          if [ -n "$FIXES" ]; then
            NOTES+="### ðŸ› ä¿®å¤\n$FIXES\n\n"
          fi

          if [ -n "$OTHERS" ]; then
            NOTES+="### ðŸ“ å…¶ä»–\n$OTHERS\n\n"
          fi

          NOTES+="---\n\n"
          NOTES+="### ðŸ“¦ å®‰è£…æ–¹å¼\n\n"
          NOTES+="1. ä¸‹è½½ \`bilibili-favorite-v${{ steps.get_version.outputs.VERSION }}.zip\`\n"
          NOTES+="2. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè¿›å…¥ \`chrome://extensions/\`\n"
          NOTES+="3. å¼€å¯ã€Œå¼€å‘è€…æ¨¡å¼ã€\n"
          NOTES+="4. å°† ZIP æ–‡ä»¶è§£åŽ‹åŽï¼Œç‚¹å‡»ã€ŒåŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åºã€\n\n"
          NOTES+="æˆ–ç›´æŽ¥ä»Ž [Chrome Web Store](https://chromewebstore.google.com/detail/b%E7%AB%99%E6%94%B6%E8%97%8F%E5%A4%B9%E6%95%B4%E7%90%86%E5%B7%A5%E5%85%B7/kompiebhklojoioghbddednmmnebnkoc) å®‰è£…"

          # ä¿å­˜åˆ°æ–‡ä»¶é¿å…å¤šè¡Œé—®é¢˜
          echo -e "$NOTES" > release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            package/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
